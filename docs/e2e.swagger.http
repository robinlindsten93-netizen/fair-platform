@baseUrl = https://localhost:5001
# Byt till din faktiska baseUrl/port (http/https) som Swagger kÃ¶r pÃ¥.
# Ex:
# @baseUrl = http://localhost:5166

###
# ================
# 0) OTP Rider
# ================
POST {{baseUrl}}/api/v1/auth/otp/request
Content-Type: application/json

{
  "phone": "+46700000001"
}

###
###
POST {{baseUrl}}/api/v1/auth/otp/verify
Content-Type: application/json

{
  "phone": "+46700000001",
  "code": "123456"
}

> {% 
  // Spara rider token
  client.global.set("riderToken", response.body.access_token);

  // ðŸ”¥ KRITISKT: spara userId (sub)
  const payload = JSON.parse(atob(response.body.access_token.split('.')[1]));
  client.global.set("riderUserId", payload.sub);
%}

###
# Grant Rider role (DEV)
POST {{baseUrl}}/api/v1/dev/roles/grant
Authorization: Bearer {{riderToken}}
Content-Type: application/json

{
  "userId": "{{riderUserId}}",
  "role": "Rider"
}

> {%
  client.test("rider role granted", function () {
    client.assert(response.status === 200);
  });
%}

###
GET {{baseUrl}}/api/v1/me
Authorization: Bearer {{riderToken}}

###
# ================
# 1) OTP Driver
# ================
POST {{baseUrl}}/api/v1/auth/otp/request
Content-Type: application/json

{
  "phone": "+46700000002"
}

###
POST {{baseUrl}}/api/v1/auth/otp/verify
Content-Type: application/json

{
  "phone": "+46700000002",
  "code": "123456"
}

> {% 
  client.global.set("driverToken", response.body.access_token);

  const payload = JSON.parse(atob(response.body.access_token.split('.')[1]));
  client.global.set("driverUserId", payload.sub);
%}

###
POST {{baseUrl}}/api/v1/dev/roles/grant
Authorization: Bearer {{driverToken}}
Content-Type: application/json

{
  "userId": "{{driverUserId}}",
  "role": "Driver"
}

###
GET {{baseUrl}}/api/v1/me
Authorization: Bearer {{driverToken}}

###
# ================
# 2) Driver online
# ================
POST {{baseUrl}}/api/v1/driver/me/availability
Authorization: Bearer {{driverToken}}
Content-Type: application/json

{
  "isOnline": true
}

###
GET {{baseUrl}}/api/v1/driver/me
Authorization: Bearer {{driverToken}}

###
# ================
# 3) Create Trip (Quoted)
# ================
# Om du har en endpoint som skapar QuoteToken: kÃ¶r den hÃ¤r och spara quoteToken.
# Annars: sÃ¤tt quoteToken manuellt i variabeln nedan.
@quoteToken = PASTE_QUOTE_TOKEN_HERE

POST {{baseUrl}}/api/v1/trips
Authorization: Bearer {{riderToken}}
Content-Type: application/json

{
  "pickupLat": 59.3293,
  "pickupLng": 18.0686,
  "dropoffLat": 59.3326,
  "dropoffLng": 18.0649,
  "mode": 0,
  "quoteToken": "{{quoteToken}}"
}

> {% 
  // Spara tripId frÃ¥n create-responsen. Anpassa property om din DTO heter annorlunda.
  client.global.set("tripId", response.body.tripId ?? response.body.id);
%}

###
GET {{baseUrl}}/api/v1/trips/{{tripId}}
Authorization: Bearer {{riderToken}}

###
# ================
# 4) Request Trip (dispatch kick)
# ================
POST {{baseUrl}}/api/v1/trips/{{tripId}}/request
Authorization: Bearer {{riderToken}}
Content-Type: application/json

{
  "quoteToken": "{{quoteToken}}"
}

###
# Rider active trip
GET {{baseUrl}}/api/v1/trips/my/active
Authorization: Bearer {{riderToken}}

###
# ================
# 5) Driver offers
# ================
# Byt endpoint om din dispatch-controller har annan route.
GET {{baseUrl}}/api/v1/dispatch/offers/my
Authorization: Bearer {{driverToken}}

> {%
  // plocka fÃ¶rsta offerId
  if (response.body && response.body.length > 0) {
    client.global.set("offerId", response.body[0].offerId ?? response.body[0].id);
  }
%}

###
# ================
# 6) Accept offer (single winner) -> trip Accepted
# ================
# Byt endpoint om din accept-route heter annorlunda.
POST {{baseUrl}}/api/v1/dispatch/offers/{{offerId}}/accept
Authorization: Bearer {{driverToken}}
Content-Type: application/json

{}

###
# Driver active trip (should be Accepted)
GET {{baseUrl}}/api/v1/trips/driver/my/active
Authorization: Bearer {{driverToken}}

###
# Rider active trip (should be Accepted)
GET {{baseUrl}}/api/v1/trips/my/active
Authorization: Bearer {{riderToken}}

###
# ================
# 7) Lifecycle: Arrive -> Start -> Complete
# ================
POST {{baseUrl}}/api/v1/trips/{{tripId}}/arrive
Authorization: Bearer {{driverToken}}
Content-Type: application/json

{}

###
POST {{baseUrl}}/api/v1/trips/{{tripId}}/start
Authorization: Bearer {{driverToken}}
Content-Type: application/json

{}

###
POST {{baseUrl}}/api/v1/trips/{{tripId}}/complete
Authorization: Bearer {{driverToken}}
Content-Type: application/json

{}

###
# ================
# 8) Read models: history
# ================
GET {{baseUrl}}/api/v1/trips/my
Authorization: Bearer {{riderToken}}

###
GET {{baseUrl}}/api/v1/trips/driver/my
Authorization: Bearer {{driverToken}}